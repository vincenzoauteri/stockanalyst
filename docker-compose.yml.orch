services:
  llmdev:
    build:
      context: .
      # Use the new reusable Dockerfile.
      dockerfile: Dockerfile.base
      args:
        # Pass the specific username and permissions for this service.
        USERNAME: dev
        HOST_UID: "${HOST_UID:-1000}"
        HOST_GID: "${HOST_GID:-1000}"
        DOCKER_GID: "${DOCKER_GID:-999}"
    container_name: llmdev
    read_only: ${CONTAINER_READ_ONLY:-false} # Changed default to false for a dev environment
    environment:
      - CONTAINER_NAME=llmdev
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CLAUDE_CONFIG_DIR=${CLAUDE_CONFIG_DIR_DEV}
      - GH_CONFIG_DIR=${GH_CONFIG_DIR}
      - XDG_CONFIG_HOME=${XDG_CONFIG_HOME}
    volumes:
      # Mount the workspace, a root home directory, and the Docker socket.
      - ./workspace:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    tmpfs:
      # Use tmpfs for ephemeral data to improve performance.
      # Paths are corrected to match the user's home directory.
      - /tmp:rw,noexec,nosuid,size=1g
      - /var/run:rw,noexec,nosuid,size=1g
      - /var/log:rw,noexec,nosuid,size=1g
      - /home/dev/.npm:rw,noexec,nosuid,size=1g
      - /home/dev/.cache:rw,noexec,nosuid,size=1g
    tty: true
    stdin_open: true
    working_dir: /workspace
    restart: unless-stopped

  llmtest:
    build:
      context: .
      dockerfile: Dockerfile.base
      args:
        USERNAME: test
        HOST_UID: "${HOST_UID:-1000}"
        HOST_GID: "${HOST_GID:-1000}"
        DOCKER_GID: "${DOCKER_GID:-999}"
    container_name: llmtest
    read_only: ${CONTAINER_READ_ONLY:-true}
    environment:
      - CONTAINER_NAME=llmtest
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CLAUDE_CONFIG_DIR=${CLAUDE_CONFIG_DIR_TEST}
      - GH_CONFIG_DIR=${GH_CONFIG_DIR}
      - XDG_CONFIG_HOME=${XDG_CONFIG_HOME}
    volumes:
      # Corrected the typo from .workspace to ./workspace
      - ./workspace:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    tmpfs:
      # Corrected paths to use the 'test' user's home directory.
      - /tmp:rw,noexec,nosuid,size=100m
      - /var/run:rw,noexec,nosuid,size=50m
      - /var/log:rw,noexec,nosuid,size=50m
      - /home/test/.npm:rw,noexec,nosuid,size=100m
      - /home/test/.cache:rw,noexec,nosuid,size=100m
    tty: true
    stdin_open: true
    working_dir: /workspace
    restart: unless-stopped

  llmdir:
    build:
      context: .
      dockerfile: Dockerfile.base
      args:
        USERNAME: dir
        HOST_UID: "${HOST_UID:-1000}"
        HOST_GID: "${HOST_GID:-1000}"
        DOCKER_GID: "${DOCKER_GID:-999}"
    container_name: llmdir
    read_only: ${CONTAINER_READ_ONLY:-true}
    environment:
      - CONTAINER_NAME=llmdir
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - CLAUDE_CONFIG_DIR=${CLAUDE_CONFIG_DIR_DIR}
      - GH_CONFIG_DIR=${GH_CONFIG_DIR}
      - XDG_CONFIG_HOME=${XDG_CONFIG_HOME}
    volumes:
      - ./workspace:/workspace
      - /var/run/docker.sock:/var/run/docker.sock
    tmpfs:
      # Corrected paths to use the 'dir' user's home directory.
      - /tmp:rw,noexec,nosuid,size=100m
      - /var/run:rw,noexec,nosuid,size=50m
      - /var/log:rw,noexec,nosuid,size=50m
      - /home/dir/.npm:rw,noexec,nosuid,size=100m
      - /home/dir/.cache:rw,noexec,nosuid,size=100m
    tty: true
    stdin_open: true
    working_dir: /workspace
    restart: unless-stopped
